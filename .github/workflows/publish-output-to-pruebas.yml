name: publish-output-to-pruebas

on:
  push:

permissions:
  contents: write

jobs:
  publish-output:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure output exists
        run: |
          if [ ! -d "output" ]; then
            echo "ERROR: folder 'output/' does not exist."
            exit 1
          fi
          if [ -z "$(ls -A output 2>/dev/null)" ]; then
            echo "ERROR: folder 'output/' is empty."
            exit 1
          fi

      - name: Prepare worktree for target branch (pruebas)
        run: |
          set -e

          git fetch origin pruebas || true

          # Si ya existe el worktree, bórralo para evitar estados raros
          if [ -d "_wt_pruebas" ]; then
            git worktree remove --force _wt_pruebas
          fi

          # Crea el worktree en una rama real (no detached)
          if git show-ref --quiet refs/remotes/origin/pruebas; then
            git worktree add -B pruebas _wt_pruebas origin/pruebas
          else
            # Si no existiera, créala desde el commit actual
            git branch pruebas
            git push -u origin pruebas
            git worktree add -B pruebas _wt_pruebas pruebas
          fi

      - name: Sync output/ into pruebas branch root
        run: |
          set -e
          WT="_wt_pruebas"

          # Borra en pruebas solo lo que vaya a ser reemplazado por output/*
          for item in output/*; do
            base="$(basename "$item")"
            rm -rf "${WT:?}/${base}"
          done

          # Copia output/* al root de pruebas (mantiene carpetas: Sophos/, etc.)
          rsync -a output/ "${WT}/"

      - name: Commit and push (if any)
        run: |
          set -e
          cd _wt_pruebas

          # Detecta cambios incluyendo untracked
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore: publish output to pruebas [skip ci]"
          git push origin pruebas
